name: ðŸš€ è‡ªåŠ¨éƒ¨ç½² Xiaoxu ä¸»é¢˜

on:
  push:
    branches: [ main, master ]
    paths:
      - 'web/src/**'
      - 'web/public/**'
      - 'web/*.json'
      - 'web/*.js'
      - 'web/*.ts'
      - '.github/workflows/**'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸŸ¢ è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: web/package-lock.json
    
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        cd web
        npm ci
    
    - name: ðŸ”¨ æž„å»ºé¡¹ç›®
      run: |
        cd web
        npm run build
      env:
        NODE_ENV: production
    
    - name: ðŸ“‹ éªŒè¯æž„å»ºç»“æžœ
      run: |
        echo "=== æž„å»ºç»“æžœéªŒè¯ ==="
        ls -la web/Xiaoxu/
        echo "Assetsç›®å½•å†…å®¹:"
        ls -la web/Xiaoxu/assets/ | head -10
        echo "æž„å»ºæ–‡ä»¶æ•°é‡: $(find web/Xiaoxu/assets -type f | wc -l)"
    
    - name: ðŸ’¾ æäº¤æž„å»ºç»“æžœ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add web/Xiaoxu/
        
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´ï¼Œè·³è¿‡æäº¤"
        else
          git commit -m "ðŸ¤– è‡ªåŠ¨æž„å»º: $(date '+%Y-%m-%d %H:%M:%S') [skip ci]"
          git push
        fi
    
    - name: ðŸ“Š éƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "### ðŸŽ‰ éƒ¨ç½²å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æž„å»ºæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Node.jsç‰ˆæœ¬:** ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
        echo "**èµ„æºæ–‡ä»¶æ•°é‡:** $(find web/Xiaoxu/assets -type f | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ç›®å½•ç»“æž„:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "Xiaoxu/" >> $GITHUB_STEP_SUMMARY
        echo "â”œâ”€â”€ assets/     (é™æ€æ‰“åŒ…èµ„æº)" >> $GITHUB_STEP_SUMMARY  
        echo "â”œâ”€â”€ views/" >> $GITHUB_STEP_SUMMARY
        echo "â”‚   â””â”€â”€ index.blade.php" >> $GITHUB_STEP_SUMMARY
        echo "â””â”€â”€ XiaoxuTheme.php" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
